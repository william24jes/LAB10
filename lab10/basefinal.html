<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Juego de Memoria</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">
  <style>
    .card {
      width: 150px;
      height: 150px;
      background-color: blue;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      display: none;
    }

    #boardContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 70vh;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h1>El Juego de la Memoria</h1>
  <br>
  <h6>Total de im치genes seleccionadas: <span id="numero">0</span></h6>
  <div class="custom-file mb-3">
    <input type="file" class="custom-file-input" id="imagenInput" accept=".png" multiple>
    <label class="custom-file-label" for="imagenInput">Seleccionar im치genes...</label>
  </div>
  <button id="subir" class="btn btn-primary">Subir im치genes</button>
  <button id="crear" class="btn btn-success" disabled>Crear tablero</button>
  <button id="aleatorizar" class="btn btn-warning" disabled>Aleatorizar</button>
  <button id="ayudaButton" class="btn btn-danger" disabled>Ayuda (2)</button>
</div>

<div class="container mt-4">
  <div id="imagenesGuardadas" class="row"></div>
</div>

<div class="container mt-4">
  <button id="empezarJuego" class="btn btn-primary" style="display: none;">Empezar juego</button>
  <div id="boardContainer">
    <div id="tablero"></div>
  </div>
</div>

<script>
  $(document).ready(function () {
    var imagesArray = [];
    var max = 15;
    var lastTwoCards = [];
    var lockCards = false;
    var gameStarted = false; // Variable to track if the game has started
    var helpUsed = 0; // Variable to track the number of times "Ayuda" button is used

    $('#subir').click(function () {
      var files = $('#imagenInput').get(0).files;
      if (files.length > 0 && files.length <= max) {
        var addedImagesCount = 0;
        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          if (file.type !== 'image/png') {
            alert('Por favor, selecciona solo archivos en formato PNG.');
            continue;
          }
          var reader = new FileReader();
          reader.onload = (function (file) {
            return function (e) {
              var image = e.target.result;
              if (!imagesArray.includes(image)) {
                imagesArray.push(image);
                addedImagesCount++;
                $('#imagenesGuardadas').append('<div class="col-4"><button style="height: 30px;width: 30px" class="borrar" data-id="' + (imagesArray.length - 1) + '">X</button><img class="img-fluid" src="' + image + '" ></div>');
              }
              updateSelectedImagesCount();
              if (addedImagesCount === files.length) {
                updateCreateButtonState();
              }
            };
          })(file);
          reader.readAsDataURL(file);
        }
      } else {
        alert('Por favor, selecciona entre 1 y ' + max + ' im치genes.');
      }
    });

    $(document).on('click', '.borrar', function () {
      var id = $(this).data('id');
      imagesArray.splice(id, 1);
      $(this).parent().remove();
      updateSelectedImagesCount();
      updateCreateButtonState();
      $('.borrar').each(function (index) {
        $(this).data('id', index);
      });
    });

    function updateSelectedImagesCount() {
      var uniqueImagesCount = getUniqueImageCount(imagesArray);
      $('#numero').text(uniqueImagesCount);
    }

    function updateCreateButtonState() {
      if (imagesArray.length >= 2 && imagesArray.length <= max) {
        $("#crear").attr("disabled", false);
      } else {
        $("#crear").attr("disabled", true);
      }
    }

    function getUniqueImageCount(arr) {
      var uniqueImages = [];
      for (var i = 0; i < arr.length; i++) {
        if (uniqueImages.indexOf(arr[i]) === -1) {
          uniqueImages.push(arr[i]);
        }
      }
      return uniqueImages.length;
    }

    $('#crear').click(function () {
      var shuffledImages = imagesArray.concat(imagesArray);
      shuffleArray(shuffledImages);
      createBoard(shuffledImages);
      $("#aleatorizar").attr("disabled", false); // Enable the "Aleatorizar" button after board creation
      $("#ayudaButton").attr("disabled", false); // Enable the "Ayuda" button after board creation
      $("#empezarJuego").css("display", "block"); // Show "Empezar Juego" button after board creation
    });

    $('#aleatorizar').click(function () {
      var cards = $('.card');
      var randomizedIndices = generateRandomIndices(cards.length);

      cards.each(function (index) {
        var image = $(this).find('img');
        if (!image.is(':visible')) {
          var randomizedIndex = randomizedIndices[index];
          var targetCard = cards.eq(randomizedIndex);
          var targetImage = targetCard.find('img');

          if (!targetImage.is(':visible')) {
            var tempSrc = image.attr('src');
            image.attr('src', targetImage.attr('src'));
            targetImage.attr('src', tempSrc);
          }
        }
      });
    });

    $('#ayudaButton').click(function () {
      if (helpUsed < 2) {
        var cards = $('.card:not(.help)');
        var availableImages = {};
        cards.each(function (index) {
          var img = $(this).find('img');
          if (!img.is(':visible')) {
            var imgSrc = img.attr('src');
            if (availableImages[imgSrc]) {
              availableImages[imgSrc].push(index);
            } else {
              availableImages[imgSrc] = [index];
            }
          }
        });

        // Find an image that has at least two cards
        var selectedIndices = null;
        for (var imgSrc in availableImages) {
          if (availableImages[imgSrc].length >= 2) {
            selectedIndices = availableImages[imgSrc].slice(0, 2); // get the first two indices
            break;
          }
        }

        if (selectedIndices) {
          var img1 = cards.eq(selectedIndices[0]).find('img');
          var img2 = cards.eq(selectedIndices[1]).find('img');

          img1.show();
          img2.show();
          img1.parent().addClass('help');
          img2.parent().addClass('help');

          helpUsed++;
          $('#ayudaButton').text('Ayuda (' + (2 - helpUsed) + ')');

          if (helpUsed >= 2) {
            $('#ayudaButton').attr('disabled', true);
          }
        }
      }
    });


    function getRandomIndices(length, count) {
      var indices = [];
      for (var i = 0; i < length; i++) {
        indices.push(i);
      }
      shuffleArray(indices);
      return indices.slice(0, count);
    }
    $('#empezarJuego').click(function () {
      gameStarted = true;
     /* $('.card').click(function () {
        if (!gameStarted || lockCards) return; // Don't process click if game is not started or cards are locked

        var img = $(this).find('img');
        img.show();

        lastTwoCards.push(img);

        if (lastTwoCards.length === 2) {
          lockCards = true;
          if (lastTwoCards[0].attr('src') === lastTwoCards[1].attr('src')) {
            // If match, stay open
            lastTwoCards = [];
            lockCards = false;
          } else {
            // If not match, close after 1 second
            setTimeout(function () {
              lastTwoCards[0].hide();
              lastTwoCards[1].hide();
              lastTwoCards = [];
              lockCards = false;
            }, 1000);
          }
        }
      });*/
      $('.card').click(function () {
        if (!gameStarted || lockCards) return; // Don't process click if game is not started or cards are locked

        var img = $(this).find('img');
        img.show();

        lastTwoCards.push(img);

        if (lastTwoCards.length === 2) {
          lockCards = true;
          if (lastTwoCards[0].attr('src') === lastTwoCards[1].attr('src')) {
            // If match, stay open
            lastTwoCards = [];
            lockCards = false;

            if (checkAllCardsMatched()) {
              setTimeout(resetGame, 1000); // Delay to let user see the final state
            }
          } else {
            // If not match, close after 1 second
            setTimeout(function () {
              lastTwoCards[0].hide();
              lastTwoCards[1].hide();
              lastTwoCards = [];
              lockCards = false;
            }, 1000);
          }
        }
      });

    });
    function resetGame() {
      gameStarted = false;
      helpUsed = 0;
      $('#ayudaButton').text('Ayuda (2)');
      $('#ayudaButton').attr('disabled', true);
      $('#empezarJuego').hide();
      $("#aleatorizar").attr("disabled", true);
      imagesArray = [];
      $('#imagenesGuardadas').empty();
      $('#tablero').empty();
      updateSelectedImagesCount();
      updateCreateButtonState();
    }


    function createBoard(images) {
      var dimensions = getBoardDimensions(images.length);
      var rows = dimensions[0];
      var cols = dimensions[1];
      for (var i = 0; i < rows; i++) {
        var row = $('<div class="row"></div>');
        for (var j = 0; j < cols; j++) {
          if (images.length > 0) {
            var card = $('<div class="card"></div>');
            var img = $('<img src="' + images.pop() + '">');
            card.append(img);
            row.append(card);
          }
        }
        $('#tablero').append(row);
      }
    }

    function getBoardDimensions(n) {
      var r = Math.floor(Math.sqrt(n));
      while (n % r !== 0) {
        r--;
      }
      return [n / r, r];
    }

    function shuffleArray(array) {
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateRandomIndices(length) {
      var indices = [];
      for (var i = 0; i < length; i++) {
        indices.push(i);
      }
      shuffleArray(indices);
      return indices;
    }
    function checkAllCardsMatched() {
      var allMatched = true;
      $('.card').each(function () {
        var img = $(this).find('img');
        if (!img.is(':visible')) {
          allMatched = false;
          return false; // break the loop
        }
      });
      return allMatched;
    }
  });
</script>
</body>
</html>
