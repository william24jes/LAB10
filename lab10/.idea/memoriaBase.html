<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Juego de Memoria</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">
  <style>
    .card {
      width: 100px;
      height: 100px;
      background-color: blue;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      display: none;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h1>El Juego de la Memoria</h1>
  <br>
  <h6>Total de im치genes seleccionadas: <span id="numero">0</span></h6>
  <div class="custom-file mb-3">
    <input type="file" class="custom-file-input" id="imagenInput" accept=".png" multiple>
    <label class="custom-file-label" for="imagenInput">Seleccionar im치genes...</label>
  </div>
  <button id="subir" class="btn btn-primary">Subir im치genes</button>
  <button id="crear" class="btn btn-success" disabled>Crear tablero</button>
</div>

<div class="container mt-4">
  <div id="imagenesGuardadas" class="row"></div>
</div>

<div class="container mt-4">
  <button id="empezarJuego" class="btn btn-primary" style="display: none;">Empezar juego</button>
  <div id="tablero"></div>
</div>

<script>
  $(document).ready(function () {
    var imagesArray = [];
    var max = 15;
    var lastTwoCards = [];
    var lockCards = false;

    $('#subir').click(function () {
      var files = $('#imagenInput').get(0).files;
      if (files.length > 0 && files.length <= max) {
        var addedImagesCount = 0;
        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          if (file.type !== 'image/png') {
            alert('Por favor, selecciona solo archivos en formato PNG.');
            continue;
          }
          var reader = new FileReader();
          reader.onload = (function (file) {
            return function (e) {
              var image = e.target.result;
              if (!imagesArray.includes(image)) {
                imagesArray.push(image);
                addedImagesCount++;
                $('#imagenesGuardadas').append('<div class="col-4"><button style="height: 30px;width: 30px" class="borrar" data-id="' + (imagesArray.length - 1) + '">X</button><img class="img-fluid" src="' + image + '" ></div>');
              }
              updateSelectedImagesCount();
              if (addedImagesCount === files.length) {
                updateCreateButtonState();
              }
            };
          })(file);
          reader.readAsDataURL(file);
        }
      } else {
        alert('Por favor, selecciona entre 1 y ' + max + ' im치genes.');
      }
    });

    $(document).on('click', '.borrar', function () {
      var id = $(this).data('id');
      imagesArray.splice(id, 1);
      $(this).parent().remove();
      updateSelectedImagesCount();
      updateCreateButtonState();
      $('.borrar').each(function(index) {
        $(this).data('id', index);
      });
    });

    function updateSelectedImagesCount() {
      var uniqueImagesCount = getUniqueImageCount(imagesArray);
      $('#numero').text(uniqueImagesCount);
    }

    function updateCreateButtonState() {
      if (imagesArray.length >= 2 && imagesArray.length <= max) {
        $("#crear").attr("disabled", false);
      } else {
        $("#crear").attr("disabled", true);
      }
    }

    function getUniqueImageCount(arr) {
      var uniqueImages = [];
      for (var i = 0; i < arr.length; i++) {
        if (uniqueImages.indexOf(arr[i]) === -1) {
          uniqueImages.push(arr[i]);
        }
      }
      return uniqueImages.length;
    }

    $('#crear').click(function () {
      var shuffledImages = imagesArray.concat(imagesArray);
      shuffleArray(shuffledImages);
      createBoard(shuffledImages);
    });

    function createBoard(images) {
      var dimensions = getBoardDimensions(images.length);
      var rows = dimensions[0];
      var cols = dimensions[1];
      for (var i = 0; i < rows; i++) {
        var row = $('<div class="row"></div>');
        for (var j = 0; j < cols; j++) {
          if(images.length > 0){
            var card = $('<div class="card"></div>');
            var img = $('<img src="' + images.pop() + '">');
            card.append(img);
            row.append(card);
          }
        }
        $('#tablero').append(row);
      }

      $('.card').click(function () {
        if (lockCards) return;

        var img = $(this).find('img');
        img.show();

        lastTwoCards.push(img);

        if (lastTwoCards.length === 2) {
          lockCards = true;
          if (lastTwoCards[0].attr('src') === lastTwoCards[1].attr('src')) {
            // If match, stay open
            lastTwoCards = [];
            lockCards = false;
          } else {
            // If not match, close after 1 second
            setTimeout(function () {
              lastTwoCards[0].hide();
              lastTwoCards[1].hide();
              lastTwoCards = [];
              lockCards = false;
            }, 1000);
          }
        }
      });
    }

    function getBoardDimensions(n) {
      var r = Math.floor(Math.sqrt(n));
      while (n % r !== 0) {
        r--;
      }
      return [n / r, r];
    }

    function shuffleArray(array) {
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
  });
</script>
</body>
</html>
